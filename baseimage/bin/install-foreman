#!/bin/bash

set -e
source /etc/mother-versions
export DEBIAN_FRONTEND=noninteractive

bl 'installing Foreman packages...'
apt-get update
apt-get install -qqy \
  libcurl4-openssl-dev \
  apache2-mpm-worker \
  apache2-threaded-dev \
  libapr1-dev \
  libaprutil1-dev \
  foreman-postgresql="${FOREMAN_VERSION}*" \
  foreman-compute="${FOREMAN_VERSION}*" \
  foreman-libvirt="${FOREMAN_VERSION}*" \
  foreman-cli="${FOREMAN_VERSION}*" \
  ruby-hammer-cli-foreman-discovery \
  ruby-foreman-discovery \
  ruby-foreman-dhcp-browser \
  ruby-foreman-docker \
  ruby-foreman-hooks \
  ruby-puppetdb-foreman \
  python-websocket \
  ruby-foreman-templates

bl "installing Passenger..."
cd /usr/share/foreman
echo "gem 'passenger'" > bundler.d/passenger.rb
bundle install

bl "compiling Apache's mod_passenger (this may take a while)..."
bundle exec passenger-install-apache2-module --auto 2>&1 | tee /etc/apache2/.passenger_install_log.txt

b "installing Apache's passenger..."
PASSENGER_MOD=$(awk '/^\ +LoadModule/ { print $3 }' /etc/apache2/.passenger_install_log.txt)
PASSENGER_ROOT=$(awk '/^\ +PassengerRoot/ { print $2 }' /etc/apache2/.passenger_install_log.txt)
PASSENGER_RUBY=$(awk '/^\ +PassengerDefaultRuby/ { print $2 }' /etc/apache2/.passenger_install_log.txt)
echo "# this config is autogenerated by docker build
LoadModule passenger_module ${PASSENGER_MOD}
<IfModule mod_passenger.c>
  PassengerRoot ${PASSENGER_ROOT}
  PassengerDefaultRuby ${PASSENGER_RUBY}
  PassengerHighPerformance on
  PassengerMaxPoolSize 12
  PassengerPoolIdleTime 1500
  PassengerStatThrottleRate 120
  PassengerEnabled On
</IfModule>
" > /etc/apache2/mods-available/passenger.load
a2enmod passenger &>/dev/null
bl "done"

b "reconfiguring listen ports..."
echo "# this config is autogenerated by docker build
Listen 80
Listen 443
" > /etc/apache2/ports.conf
bl "done"

b "preparing Foreman's VirtualHost..."
touch /etc/apache2/sites-available/foreman.conf
a2ensite foreman &>/dev/null
bl 'done'
